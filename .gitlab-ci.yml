stages:
  - build
  - preview

build_alpi:
  stage: build
  image: google/cloud-sdk:316.0.0-alpine
  script:
    - echo $GCP_SERVICE_KEY > gcloud-service-key.json
    - gcloud auth activate-service-account --key-file gcloud-service-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud builds submit ./alpi --config=./alpi/cloudbuild.yaml --substitutions=_COMMIT_SHA=$CI_COMMIT_SHA,_HELM_REPO=test212
    - echo "BUILD_VERSION=hello" >> build.env
  artifacts:
    reports:
      dotenv: build.env
  only:
    refs:
      - merge_requests
    changes:
      - "alpi/**/*"

build_cloudBuilder:
  stage: build
  image: google/cloud-sdk:316.0.0-alpine
  script:
    - echo $GCP_SERVICE_KEY > gcloud-service-key.json
    - gcloud auth activate-service-account --key-file gcloud-service-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud builds submit ./cloudBuilder --config=./cloudBuilder/cloudbuild.yaml
  only:
    refs:
      - merge_requests
    changes:
      - "cloudBuilder/**/*"

preview:
  stage: preview
  variables:
    BRANCH_NAME: $CI_COMMIT_REF_NAME
    COMMIT_SHA: $CI_COMMIT_SHA
  trigger: 
    project: dmoiseenko/kon-config
  only:
    refs:
      - merge_requests