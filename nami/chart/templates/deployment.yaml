apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    {{- include "nami.labels" . | nindent 4 }}
    hasuraService: custom
  name: {{ include "nami.fullname" . }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "nami.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      creationTimestamp: null
      labels:
        {{- include "nami.selectorLabels" . | nindent 8 }}
      annotations:
        vault.hashicorp.com/agent-init-first: "true"
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "internal-app"
        vault.hashicorp.com/agent-inject-secret-database-config: "internal/data/database/config"
        vault.hashicorp.com/agent-inject-template-database-config: |
          {{`{{- with secret "internal/data/database/config" -}}
            export HASURA_GRAPHQL_DATABASE_URL=postgres://{{ .Data.data.username }}:{{ .Data.data.password }}@35.196.127.103:5432/nami
          {{- end }}`}}
        vault.hashicorp.com/agent-inject-secret-hasura-config: "internal/data/hasura"
        vault.hashicorp.com/agent-inject-template-hasura-config: |
          {{`{{- with secret "internal/data/hasura" -}}
            export HASURA_GRAPHQL_ADMIN_SECRET={{ .Data.data.admin_secret }}
          {{- end }}`}}
    spec:
      serviceAccountName: nami
      containers:
      - image: hasura/graphql-engine:v1.3.3
        imagePullPolicy: IfNotPresent
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8080
        name: {{ .Chart.Name }}
        args:
            ['sh', '-c', 'source /vault/secrets/database-config && source /vault/secrets/hasura-config && graphql-engine serve']
        env:
        - name: HASURA_GRAPHQL_ENABLE_CONSOLE
          value: "true"
        - name: HASURA_GRAPHQL_DEV_MODE
          value: "true"
        - name: HASURA_GRAPHQL_ENABLED_APIS
          value: "graphql,metadata,config"
        - name: HASURA_GRAPHQL_CONSOLE_ASSETS_DIR
          value: "/srv/console-assets"
        - name: HASURA_GRAPHQL_JWT_SECRET
          value: '{"keys":[{"alg":"RS256","kty":"RSA","use":"sig","n":"vyxZQR4KbB747_4RSDzBKRp66yTWkddWywFRbp3Y33z3_hrOO2U9e39uZhE1oYyfgIU8oET-hr980AQ3RjVUrMITfuKRj86QXe1_VuKIB0d6pXkBjJ6mZejXAuIpLGU1cwjNdZqgom4yM_ltxHzyOjUf56GRXZaH_A45Sycf4Zc_BuyRXAP02ZbrIqDcVg57sL8P7ONmEJOtUOYTOFIDgzXu0x_--huW8pomOGACzljFkVoRvvuhxHa3B9RpjKf4GeMFJAkeDVx2CJT-9ZJq6d-HV7Nn2b3Zop_QT1mUoGkwtTWH2hU3xr5mfOO-rWmL4LvaH09P6Xfr3z8e3aYo_Q","e":"AQAB","kid":"GtfLZ20nmdDI2o_pGENbG","x5t":"hDj4VXtfA2Nl5Tm201pdnQBdE5k","x5c":["MIIDCTCCAfGgAwIBAgIJGrsmVe/+3d1wMA0GCSqGSIb3DQEBCwUAMCIxIDAeBgNVBAMTF2Rtb2lzZWVua28udXMuYXV0aDAuY29tMB4XDTIxMDExMTExMjkxNVoXDTM0MDkyMDExMjkxNVowIjEgMB4GA1UEAxMXZG1vaXNlZW5rby51cy5hdXRoMC5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC/LFlBHgpsHvjv/hFIPMEpGnrrJNaR11bLAVFundjffPf+Gs47ZT17f25mETWhjJ+AhTygRP6Gv3zQBDdGNVSswhN+4pGPzpBd7X9W4ogHR3qleQGMnqZl6NcC4iksZTVzCM11mqCibjIz+W3EfPI6NR/noZFdlof8DjlLJx/hlz8G7JFcA/TZlusioNxWDnuwvw/s42YQk61Q5hM4UgODNe7TH/76G5bymiY4YALOWMWRWhG++6HEdrcH1GmMp/gZ4wUkCR4NXHYIlP71kmrp34dXs2fZvdmin9BPWZSgaTC1NYfaFTfGvmZ8476taYvgu9ofT0/pd+vfPx7dpij9AgMBAAGjQjBAMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFDMokJ1lW6PbZ9Y12guvN/Q/bJ0lMA4GA1UdDwEB/wQEAwIChDANBgkqhkiG9w0BAQsFAAOCAQEAaujTAO2YFAKS/mrm37sXfnnJM+wYCgnS63j9UouGEofoLtXQ1jN7OuyUCt6ARfVdYyfefOckDb5MPPz2MHrYPe3+GrA/gXvzFrEAMcMVb2YBofg6vAIoVeuhROXylsmdXDImNdy2AHDV7W/EkR2MmdfpAWlJq9/F0vNrDUeSVpZvt0RB4vkvNvVP3HzIOBD7RzSywg+NQQhlF7bLI6nrDWibKa5DWwx+Pf2guEmHws2gIz9gfIw7n97pmc+mdeBGyu9lx81aK0D20ZF6n9qyBhhfXZSaIzZxaaVAorlyZPOyw1trq7PXMqyyccQgFid2fig3MN0yVLr+/V4mTZb4vA=="]},{"alg":"RS256","kty":"RSA","use":"sig","n":"wRlClb6cxrEJqu__J0IjiinPi5JkKFRhjCRil4EOZHdITpvW9XvAFHyNC6yQePh7o6xVEZWQ7HjrV56hCEEe42UUvvA3qGeCW5YaLUP6CrmntYh-U-OV9k2EfzHEjZdfQ58fMTjLs3hoJgh9cUYV7yMaP7V0GN0Vtl_d9MqXnLxzWz_VVl8ee8bJ8OXCDG0QUzV5xikW6ccVpz_PHZkFa7ixzPYkNxmK1KrXu0SMU1IkLY5Kawb_ojCMRhvzQftPDd5cgjU3v3BKJYFKNQqdueyfFtmmuqKrUd4CA9rdr575CS0-dOTK31cUp8cRx01Nf0I52J-2TH3AhH0LiZ_5Mw","e":"AQAB","kid":"T1oinghZFZF3EuskebhRT","x5t":"dIcEHoj_ew2nDMKX2VCdLxfSTpQ","x5c":["MIIDCTCCAfGgAwIBAgIJChuJerfLfGvEMA0GCSqGSIb3DQEBCwUAMCIxIDAeBgNVBAMTF2Rtb2lzZWVua28udXMuYXV0aDAuY29tMB4XDTIxMDExMTExMjkxNVoXDTM0MDkyMDExMjkxNVowIjEgMB4GA1UEAxMXZG1vaXNlZW5rby51cy5hdXRoMC5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDBGUKVvpzGsQmq7/8nQiOKKc+LkmQoVGGMJGKXgQ5kd0hOm9b1e8AUfI0LrJB4+HujrFURlZDseOtXnqEIQR7jZRS+8DeoZ4JblhotQ/oKuae1iH5T45X2TYR/McSNl19Dnx8xOMuzeGgmCH1xRhXvIxo/tXQY3RW2X930ypecvHNbP9VWXx57xsnw5cIMbRBTNXnGKRbpxxWnP88dmQVruLHM9iQ3GYrUqte7RIxTUiQtjkprBv+iMIxGG/NB+08N3lyCNTe/cEolgUo1Cp257J8W2aa6oqtR3gID2t2vnvkJLT505MrfVxSnxxHHTU1/QjnYn7ZMfcCEfQuJn/kzAgMBAAGjQjBAMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFLoqsEcla3Q3kmhbCHzTslM65QR4MA4GA1UdDwEB/wQEAwIChDANBgkqhkiG9w0BAQsFAAOCAQEAf2OXv0ksSB5dSpKHcASCnEb7fwOlY7EOBFFVaFRrdZORP8pkSuiGq9tNuz1y0UXVFBGjl5zYqKmSSxWIBrShRvBSH3xY62u54o5+Ijqv9D9by5asojMhrsjrUMLtmhzfS0X093ta7bF2YLiUDSu9hPaYXPMjrXEjzVEYJvmrayp++pHjF+3a/JeePI8ULII+14vJCn5FhERQtoj+taEjQNp1OkTcdJh/6XvSGGHO/ISZ+echwv+3sN26ktVFmzjOfwgWfXmv/vSfFEUuxYifXTBiDbVaIsF1G2Uh0BTtZKqQvhCbAfkSdF+hWFyvYR6cILhoiTKXi3X2yP2eJkJKqw=="]}]}'
        # - name: HASURA_GRAPHQL_JWT_SECRET
        #   value: '{"type": "RS512", "key": "-----BEGIN CERTIFICATE-----\nMIIDCTCCAfGgAwIBAgIJGrsmVe/+3d1wMA0GCSqGSIb3DQEBCwUAMCIxIDAeBgNV\nBAMTF2Rtb2lzZWVua28udXMuYXV0aDAuY29tMB4XDTIxMDExMTExMjkxNVoXDTM0\nMDkyMDExMjkxNVowIjEgMB4GA1UEAxMXZG1vaXNlZW5rby51cy5hdXRoMC5jb20w\nggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC/LFlBHgpsHvjv/hFIPMEp\nGnrrJNaR11bLAVFundjffPf+Gs47ZT17f25mETWhjJ+AhTygRP6Gv3zQBDdGNVSs\nwhN+4pGPzpBd7X9W4ogHR3qleQGMnqZl6NcC4iksZTVzCM11mqCibjIz+W3EfPI6\nNR/noZFdlof8DjlLJx/hlz8G7JFcA/TZlusioNxWDnuwvw/s42YQk61Q5hM4UgOD\nNe7TH/76G5bymiY4YALOWMWRWhG++6HEdrcH1GmMp/gZ4wUkCR4NXHYIlP71kmrp\n34dXs2fZvdmin9BPWZSgaTC1NYfaFTfGvmZ8476taYvgu9ofT0/pd+vfPx7dpij9\nAgMBAAGjQjBAMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFDMokJ1lW6PbZ9Y1\n2guvN/Q/bJ0lMA4GA1UdDwEB/wQEAwIChDANBgkqhkiG9w0BAQsFAAOCAQEAaujT\nAO2YFAKS/mrm37sXfnnJM+wYCgnS63j9UouGEofoLtXQ1jN7OuyUCt6ARfVdYyfe\nfOckDb5MPPz2MHrYPe3+GrA/gXvzFrEAMcMVb2YBofg6vAIoVeuhROXylsmdXDIm\nNdy2AHDV7W/EkR2MmdfpAWlJq9/F0vNrDUeSVpZvt0RB4vkvNvVP3HzIOBD7RzSy\nwg+NQQhlF7bLI6nrDWibKa5DWwx+Pf2guEmHws2gIz9gfIw7n97pmc+mdeBGyu9l\nx81aK0D20ZF6n9qyBhhfXZSaIzZxaaVAorlyZPOyw1trq7PXMqyyccQgFid2fig3\nMN0yVLr+/V4mTZb4vA==\n-----END CERTIFICATE-----"}'
        ports:
        - containerPort: 8080
          protocol: TCP
        resources: {}
